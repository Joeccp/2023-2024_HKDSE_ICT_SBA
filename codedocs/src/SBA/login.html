<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>src.SBA.login API documentation</title>
<meta name="description" content="Login function" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>src.SBA.login</code></h1>
</header>
<section id="section-intro">
<p>Login function</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Login function&#34;&#34;&#34;

# Copyright 2023 Joe Chau
#
# Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


from getpass import getpass
from hashlib import sha3_512
from logging import getLogger, Logger
from os import path
from tomllib import load as loadtoml
from typing import Any

from .colour import Colour
from .language import inputLang, printLang
from .utils import clearScreen


def hash(password: str) -&gt; str:
        &#34;&#34;&#34;
        Hash the given password using `sha3_512`
        :param password: Password to be hashed
        :type password: str
        :return: Hashed password (hexadecimal)
        :rtype: str
        &#34;&#34;&#34;
        ret: str = sha3_512(password.encode()).hexdigest()
        return ret


def login(*, first_time: bool = False) -&gt; int:
        &#34;&#34;&#34;
        Login using accounts from `data/accounts.toml`
        
        In theory more than two accounts can be supported after updating accounts.toml
        However it is not officially supported, and in all the other parts of the program,
        all normal user accounts behave like the same,
        even the ticket system does not recolonize different normal users
        
        This function will execute FOREVER util logged in successfully
        
        :param first_time: Keyword-only parameter,
                to identify whether it is the first time logging in and requires login as administrator
        :type first_time: bool
        :return:
                0 if logged in as normal user,
                1 if logged in as administrator
        :rtype: int
        :raise FileNotFoundError: If `accounts.toml` could not be found
        &#34;&#34;&#34;
        from .colour import normal_colour
        from .language import language
        
        logger: Logger = getLogger(&#39;login&#39;)
        
        logger.info(&#34;Reaching accounts.toml file&#34;)
        # Obtain the full path of the file
        absolute_path = path.dirname(__file__)
        relative_path = &#34;../../data/accounts.toml&#34;
        full_path = path.join(absolute_path, relative_path)
        try:
                with open(full_path, &#39;rb&#39;) as file:
                        logger.info(&#34;Getting accounts information&#34;)
                        file_data: dict[str, Any] = loadtoml(file)
                        account_list: list[dict[str, str]] = list(file_data.values())
                        if first_time:
                                if language == &#39;ENGLISH&#39;:
                                        message: str = &#34;To initialize, please login as admin.&#34;
                                else:
                                        message: str = &#34;請登錄為管理員以初始化系統。&#34;
                                logger.info(&#34;First time logging in, requires login as admin&#34;)
                        else:
                                message: str = &#39;&#39;
                        while True:
                                clearScreen()
                                printLang(&#34;CINEMA KIOSK SYSTEM\n\n\n&#34;, &#34;電影售票系統\n\n\n&#34;)
                                print(Colour.RED + message + normal_colour + &#34;\n\n\n&#34;)
                                logger.info(&#34;Waiting username input&#34;)
                                username: str = inputLang(&#34;Username: &#34;, &#34;用戶名稱：&#34;)
                                username: str = username.strip()
                                if username == &#39;&#39;:
                                        message: str = &#39;&#39;
                                        continue
                                username_exists: bool = False
                                for account in account_list:
                                        if account[&#34;name&#34;] == username:
                                                username_exists: bool = True
                                                user_account: dict[str, str] = account
                                if not username_exists:
                                        logger.info(&#34;Username doesn&#39;t exit&#34;)
                                        if language == &#39;ENGLISH&#39;:
                                                message: str = &#34;Username does not exists, please try again.&#34;
                                        else:
                                                message: str = &#34;用戶名稱不存在，請重新輸入。&#34;
                                        continue
                                # Make sure you use cmd.exe or powershell.exe
                                # getpass() in python terminal inside IDEs may not work, e.g. PyCharm
                                if language == &#39;ENGLISH&#39;:
                                        prompt: str = &#34;Password: &#34;
                                else:
                                        prompt: str = &#34;密碼：&#34;
                                password: str = getpass(prompt).strip()
                                hashed_password: str = hash(password)
                                if user_account[&#34;hashed_password&#34;] == hashed_password:
                                        if user_account[&#34;name&#34;] == &#34;admin&#34;:
                                                logger.info(&#34;LOGGED IN AS ADMIN&#34;)
                                                return 1
                                        else:  # Login as user success
                                                if first_time:
                                                        logger.info(&#34;USER WANTS TO LOGIN BUT ONLY ADMIN CAN LOGIN NOW&#34;)
                                                        if language == &#39;ENGLISH&#39;:
                                                                message: str = &#34;Sorry, only admin can log in now as initialization is required.&#34;
                                                        else:
                                                                message: str = &#34;抱歉，現在只有管理員才能登錄。&#34;
                                                        continue
                                                logger.info(&#34;LOGGED IN AS USER&#34;)
                                                return 0
                                else:
                                        logger.info(&#34;Incorrect password&#34;)
                                        if language == &#39;ENGLISH&#39;:
                                                message: str = &#34;Password incorrect, please try again.&#34;
                                        else:
                                                message: str = &#34;密碼錯誤，請重新登錄。&#34;
        
        except FileNotFoundError:
                logger.critical(&#34;No accounts.toml file&#34;)
                logger.critical(&#34;QUITTING THE PROGRAM: No accounts information&#34;)
                # Important error message for a critical error, no translation is needed (to prevent further error)
                print(&#34;Cannot find accounts.toml which is necessary for the login function.&#34;)
                print(&#34;Exiting the program...&#34;)
                quit()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="src.SBA.login.hash"><code class="name flex">
<span>def <span class="ident">hash</span></span>(<span>password: str) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Hash the given password using <code>sha3_512</code>
:param password: Password to be hashed
:type password: str
:return: Hashed password (hexadecimal)
:rtype: str</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def hash(password: str) -&gt; str:
        &#34;&#34;&#34;
        Hash the given password using `sha3_512`
        :param password: Password to be hashed
        :type password: str
        :return: Hashed password (hexadecimal)
        :rtype: str
        &#34;&#34;&#34;
        ret: str = sha3_512(password.encode()).hexdigest()
        return ret</code></pre>
</details>
</dd>
<dt id="src.SBA.login.login"><code class="name flex">
<span>def <span class="ident">login</span></span>(<span>*, first_time: bool = False) ‑> int</span>
</code></dt>
<dd>
<div class="desc"><p>Login using accounts from <code>data/accounts.toml</code></p>
<p>In theory more than two accounts can be supported after updating accounts.toml
However it is not officially supported, and in all the other parts of the program,
all normal user accounts behave like the same,
even the ticket system does not recolonize different normal users</p>
<p>This function will execute FOREVER util logged in successfully</p>
<p>:param first_time: Keyword-only parameter,
to identify whether it is the first time logging in and requires login as administrator
:type first_time: bool
:return:
0 if logged in as normal user,
1 if logged in as administrator
:rtype: int
:raise FileNotFoundError: If <code>accounts.toml</code> could not be found</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def login(*, first_time: bool = False) -&gt; int:
        &#34;&#34;&#34;
        Login using accounts from `data/accounts.toml`
        
        In theory more than two accounts can be supported after updating accounts.toml
        However it is not officially supported, and in all the other parts of the program,
        all normal user accounts behave like the same,
        even the ticket system does not recolonize different normal users
        
        This function will execute FOREVER util logged in successfully
        
        :param first_time: Keyword-only parameter,
                to identify whether it is the first time logging in and requires login as administrator
        :type first_time: bool
        :return:
                0 if logged in as normal user,
                1 if logged in as administrator
        :rtype: int
        :raise FileNotFoundError: If `accounts.toml` could not be found
        &#34;&#34;&#34;
        from .colour import normal_colour
        from .language import language
        
        logger: Logger = getLogger(&#39;login&#39;)
        
        logger.info(&#34;Reaching accounts.toml file&#34;)
        # Obtain the full path of the file
        absolute_path = path.dirname(__file__)
        relative_path = &#34;../../data/accounts.toml&#34;
        full_path = path.join(absolute_path, relative_path)
        try:
                with open(full_path, &#39;rb&#39;) as file:
                        logger.info(&#34;Getting accounts information&#34;)
                        file_data: dict[str, Any] = loadtoml(file)
                        account_list: list[dict[str, str]] = list(file_data.values())
                        if first_time:
                                if language == &#39;ENGLISH&#39;:
                                        message: str = &#34;To initialize, please login as admin.&#34;
                                else:
                                        message: str = &#34;請登錄為管理員以初始化系統。&#34;
                                logger.info(&#34;First time logging in, requires login as admin&#34;)
                        else:
                                message: str = &#39;&#39;
                        while True:
                                clearScreen()
                                printLang(&#34;CINEMA KIOSK SYSTEM\n\n\n&#34;, &#34;電影售票系統\n\n\n&#34;)
                                print(Colour.RED + message + normal_colour + &#34;\n\n\n&#34;)
                                logger.info(&#34;Waiting username input&#34;)
                                username: str = inputLang(&#34;Username: &#34;, &#34;用戶名稱：&#34;)
                                username: str = username.strip()
                                if username == &#39;&#39;:
                                        message: str = &#39;&#39;
                                        continue
                                username_exists: bool = False
                                for account in account_list:
                                        if account[&#34;name&#34;] == username:
                                                username_exists: bool = True
                                                user_account: dict[str, str] = account
                                if not username_exists:
                                        logger.info(&#34;Username doesn&#39;t exit&#34;)
                                        if language == &#39;ENGLISH&#39;:
                                                message: str = &#34;Username does not exists, please try again.&#34;
                                        else:
                                                message: str = &#34;用戶名稱不存在，請重新輸入。&#34;
                                        continue
                                # Make sure you use cmd.exe or powershell.exe
                                # getpass() in python terminal inside IDEs may not work, e.g. PyCharm
                                if language == &#39;ENGLISH&#39;:
                                        prompt: str = &#34;Password: &#34;
                                else:
                                        prompt: str = &#34;密碼：&#34;
                                password: str = getpass(prompt).strip()
                                hashed_password: str = hash(password)
                                if user_account[&#34;hashed_password&#34;] == hashed_password:
                                        if user_account[&#34;name&#34;] == &#34;admin&#34;:
                                                logger.info(&#34;LOGGED IN AS ADMIN&#34;)
                                                return 1
                                        else:  # Login as user success
                                                if first_time:
                                                        logger.info(&#34;USER WANTS TO LOGIN BUT ONLY ADMIN CAN LOGIN NOW&#34;)
                                                        if language == &#39;ENGLISH&#39;:
                                                                message: str = &#34;Sorry, only admin can log in now as initialization is required.&#34;
                                                        else:
                                                                message: str = &#34;抱歉，現在只有管理員才能登錄。&#34;
                                                        continue
                                                logger.info(&#34;LOGGED IN AS USER&#34;)
                                                return 0
                                else:
                                        logger.info(&#34;Incorrect password&#34;)
                                        if language == &#39;ENGLISH&#39;:
                                                message: str = &#34;Password incorrect, please try again.&#34;
                                        else:
                                                message: str = &#34;密碼錯誤，請重新登錄。&#34;
        
        except FileNotFoundError:
                logger.critical(&#34;No accounts.toml file&#34;)
                logger.critical(&#34;QUITTING THE PROGRAM: No accounts information&#34;)
                # Important error message for a critical error, no translation is needed (to prevent further error)
                print(&#34;Cannot find accounts.toml which is necessary for the login function.&#34;)
                print(&#34;Exiting the program...&#34;)
                quit()</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="src.SBA" href="index.html">src.SBA</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="src.SBA.login.hash" href="#src.SBA.login.hash">hash</a></code></li>
<li><code><a title="src.SBA.login.login" href="#src.SBA.login.login">login</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>